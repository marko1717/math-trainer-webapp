<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–æ–∑–≤'—è–∑–∫—ñ–≤ - Claude + LaTeX</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --border: #333;
            --accent: #007aff;
            --success: #34c759;
            --warning: #ff9500;
            --error: #ff3b30;
        }
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }
        .header h1 {
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header .links { display: flex; gap: 16px; }
        .header a {
            color: var(--accent);
            text-decoration: none;
            font-size: 0.9rem;
        }

        /* Layout */
        .layout {
            display: grid;
            grid-template-columns: 350px 1fr 400px;
            gap: 20px;
            height: calc(100vh - 120px);
        }

        /* Panels */
        .panel {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .panel-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* Task List */
        .task-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 8px;
            background: var(--bg-tertiary);
            transition: all 0.2s;
        }
        .task-item:hover { background: #3a3a3a; }
        .task-item.active { border: 2px solid var(--accent); }
        .task-item.has-solution { border-left: 3px solid var(--success); }
        .task-item.no-solution { border-left: 3px solid var(--warning); }
        .task-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            background: var(--bg-primary);
        }
        .task-info { flex: 1; }
        .task-info .title { font-weight: 500; margin-bottom: 4px; }
        .task-info .meta { font-size: 0.8rem; color: var(--text-secondary); }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-quiz { background: #3b82f6; color: white; }
        .badge-short { background: #8b5cf6; color: white; }
        .badge-match { background: #06b6d4; color: white; }

        /* Task Preview */
        .task-preview-img {
            width: 100%;
            border-radius: 8px;
            background: white;
            margin-bottom: 16px;
        }
        .answer-box {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .answer-box strong { color: var(--success); }

        /* Solution Editor */
        .latex-editor {
            width: 100%;
            min-height: 200px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.85rem;
            resize: vertical;
        }
        .latex-preview {
            background: white;
            color: black;
            padding: 16px;
            border-radius: 8px;
            min-height: 150px;
            margin-top: 12px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: black; }
        .btn-lg { padding: 14px 28px; font-size: 1rem; }

        /* Progress */
        .progress-bar {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .progress-bar .fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s;
        }

        /* API Key Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
        }
        .modal-content h2 { margin-bottom: 16px; }
        .modal-content input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Filter */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .filter-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
        }
        .filter-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        /* Test selector */
        .test-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            padding: 4px 10px;
            border-radius: 6px;
        }
        .status-indicator.generating {
            background: rgba(0,122,255,0.2);
            color: var(--accent);
        }
        .status-indicator.success {
            background: rgba(52,199,89,0.2);
            color: var(--success);
        }
        .status-indicator.error {
            background: rgba(255,59,48,0.2);
            color: var(--error);
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–æ–∑–≤'—è–∑–∫—ñ–≤</h1>
            <div class="links">
                <a href="index.html">–ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å</a>
                <a href="#" onclick="showApiModal()">API –∫–ª—é—á</a>
            </div>
        </header>

        <div class="layout">
            <!-- Task List Panel -->
            <div class="panel">
                <div class="panel-header">
                    –ó–∞–≤–¥–∞–Ω–Ω—è
                    <span id="taskStats" style="font-weight: normal; font-size: 0.85rem; color: var(--text-secondary)">0 / 0</span>
                </div>
                <div class="panel-body">
                    <select class="test-select" id="testSelect" onchange="loadTest()">
                        <option value="">–í–∏–±–µ—Ä—ñ—Ç—å —Ç–µ—Å—Ç...</option>
                    </select>

                    <div class="filter-bar">
                        <button class="filter-btn active" onclick="setFilter('all')">–í—Å—ñ</button>
                        <button class="filter-btn" onclick="setFilter('no-solution')">–ë–µ–∑ —Ä–æ–∑–≤'—è–∑–∫—É</button>
                        <button class="filter-btn" onclick="setFilter('has-solution')">–ó —Ä–æ–∑–≤'—è–∑–∫–æ–º</button>
                    </div>

                    <div id="taskList"></div>
                </div>
            </div>

            <!-- Task Preview Panel -->
            <div class="panel">
                <div class="panel-header">
                    –ó–∞–≤–¥–∞–Ω–Ω—è
                    <span id="currentTaskNum">-</span>
                </div>
                <div class="panel-body" id="taskPreview">
                    <div class="empty-state">
                        <p>–í–∏–±–µ—Ä—ñ—Ç—å –∑–∞–≤–¥–∞–Ω–Ω—è –∑–ª—ñ–≤–∞</p>
                    </div>
                </div>
            </div>

            <!-- Solution Panel -->
            <div class="panel">
                <div class="panel-header">
                    –†–æ–∑–≤'—è–∑–æ–∫
                    <div id="generatingStatus"></div>
                </div>
                <div class="panel-body">
                    <button class="btn btn-primary btn-lg" style="width: 100%; margin-bottom: 16px;" onclick="generateSolution()" id="generateBtn">
                        –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Ä–æ–∑–≤'—è–∑–æ–∫
                    </button>

                    <label style="display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-secondary)">LaTeX –∫–æ–¥:</label>
                    <textarea class="latex-editor" id="latexEditor" placeholder="LaTeX –∫–æ–¥ —Ä–æ–∑–≤'—è–∑–∫—É –∑'—è–≤–∏—Ç—å—Å—è —Ç—É—Ç..."></textarea>

                    <label style="display: block; margin: 16px 0 8px; font-size: 0.9rem; color: var(--text-secondary)">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥:</label>
                    <div class="latex-preview" id="latexPreview">
                        <p style="color: #888; text-align: center;">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –∑'—è–≤–∏—Ç—å—Å—è —Ç—É—Ç</p>
                    </div>

                    <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="saveSolution()" id="saveBtn" disabled>
                            üíæ –ó–±–µ—Ä–µ–≥—Ç–∏
                        </button>
                        <button class="btn btn-warning" onclick="exportLaTeX()">
                            üìÑ .tex
                        </button>
                        <button class="btn btn-primary" onclick="exportAllData()">
                            üì¶ –ï–∫—Å–ø–æ—Ä—Ç JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div class="modal" id="apiModal">
        <div class="modal-content">
            <h2>Anthropic API –∫–ª—é—á</h2>
            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.9rem;">
                –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ä–æ–∑–≤'—è–∑–∫—ñ–≤ –ø–æ—Ç—Ä—ñ–±–µ–Ω API –∫–ª—é—á –≤—ñ–¥ Anthropic.
                –ö–ª—é—á –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ.
            </p>
            <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-...">
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-primary" onclick="saveApiKey()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button class="btn" style="background: var(--bg-tertiary);" onclick="closeApiModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let nmtData = null;
        let classtimeData = null;
        let currentTest = null;
        let currentTask = null;
        let currentFilter = 'all';
        let apiKey = localStorage.getItem('anthropic_api_key') || '';

        // Load data
        async function init() {
            try {
                const [nmtResp, classtimeResp] = await Promise.all([
                    fetch('../nmt-trainer/nmt_data.json').catch(() => null),
                    fetch('../nmt-trainer/classtime_data.json').catch(() => null)
                ]);

                if (nmtResp) nmtData = await nmtResp.json();
                if (classtimeResp) classtimeData = await classtimeResp.json();

                populateTestSelect();

                if (!apiKey) {
                    showApiModal();
                }
            } catch (e) {
                console.error('Failed to load data:', e);
            }
        }

        function populateTestSelect() {
            const select = document.getElementById('testSelect');
            let html = '<option value="">–í–∏–±–µ—Ä—ñ—Ç—å —Ç–µ—Å—Ç...</option>';

            if (nmtData?.test_sets) {
                html += '<optgroup label="NMT —Ç–µ—Å—Ç–∏">';
                nmtData.test_sets.forEach(t => {
                    html += `<option value="nmt:${t.id}">${t.name} (${t.tasks.length} –∑–∞–≤–¥–∞–Ω—å)</option>`;
                });
                html += '</optgroup>';
            }

            if (classtimeData?.test_sets) {
                // Group by folder
                const folders = {};
                classtimeData.test_sets.forEach(t => {
                    if (!folders[t.folder]) folders[t.folder] = [];
                    folders[t.folder].push(t);
                });

                Object.keys(folders).sort().forEach(folder => {
                    html += `<optgroup label="${folder}">`;
                    folders[folder].forEach(t => {
                        html += `<option value="ct:${t.id}">${t.name} (${t.tasks.length})</option>`;
                    });
                    html += '</optgroup>';
                });
            }

            select.innerHTML = html;
        }

        function loadTest() {
            const value = document.getElementById('testSelect').value;
            if (!value) {
                currentTest = null;
                renderTaskList();
                return;
            }

            const [source, id] = value.split(':');
            if (source === 'nmt') {
                currentTest = nmtData.test_sets.find(t => t.id === id);
            } else {
                currentTest = classtimeData.test_sets.find(t => t.id === id);
            }

            renderTaskList();
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(filter === 'all' ? '–≤—Å—ñ' : filter === 'no-solution' ? '–±–µ–∑' : '–∑ —Ä–æ–∑–≤'));
            });
            renderTaskList();
        }

        function renderTaskList() {
            const container = document.getElementById('taskList');

            if (!currentTest) {
                container.innerHTML = '<div class="empty-state">–í–∏–±–µ—Ä—ñ—Ç—å —Ç–µ—Å—Ç</div>';
                document.getElementById('taskStats').textContent = '0 / 0';
                return;
            }

            let tasks = currentTest.tasks;

            // Apply filter
            if (currentFilter === 'no-solution') {
                tasks = tasks.filter(t => !t.solution_photo && !t.solution_latex);
            } else if (currentFilter === 'has-solution') {
                tasks = tasks.filter(t => t.solution_photo || t.solution_latex);
            }

            const withSolution = currentTest.tasks.filter(t => t.solution_photo || t.solution_latex).length;
            document.getElementById('taskStats').textContent = `${withSolution} / ${currentTest.tasks.length}`;

            container.innerHTML = tasks.map(task => {
                const hasSolution = task.solution_photo || task.solution_latex;
                const imgSrc = task.photo_url || (task.photo ? `../nmt-trainer/images/${task.photo}` : '');

                return `
                    <div class="task-item ${hasSolution ? 'has-solution' : 'no-solution'} ${currentTask?.task_num === task.task_num ? 'active' : ''}"
                         onclick="selectTask(${task.task_num})">
                        ${imgSrc ? `<img class="task-thumb" src="${imgSrc}" alt="">` : '<div class="task-thumb"></div>'}
                        <div class="task-info">
                            <div class="title">–ó–∞–≤–¥–∞–Ω–Ω—è ${task.task_num}</div>
                            <div class="meta">
                                <span class="badge badge-${task.type}">${task.type}</span>
                                ${hasSolution ? '<span style="color: var(--success);">–Ñ —Ä–æ–∑–≤\'—è–∑–æ–∫</span>' : '<span style="color: var(--warning);">–ë–µ–∑ —Ä–æ–∑–≤\'—è–∑–∫—É</span>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectTask(taskNum) {
            currentTask = currentTest.tasks.find(t => t.task_num === taskNum);
            renderTaskList();
            renderTaskPreview();
            loadSolution();
        }

        function renderTaskPreview() {
            const container = document.getElementById('taskPreview');
            document.getElementById('currentTaskNum').textContent = currentTask ? `#${currentTask.task_num}` : '-';

            if (!currentTask) {
                container.innerHTML = '<div class="empty-state"><p>–í–∏–±–µ—Ä—ñ—Ç—å –∑–∞–≤–¥–∞–Ω–Ω—è –∑–ª—ñ–≤–∞</p></div>';
                return;
            }

            const imgSrc = currentTask.photo_url || (currentTask.photo ? `../nmt-trainer/images/${currentTask.photo}` : '');

            container.innerHTML = `
                ${imgSrc ? `<img class="task-preview-img" src="${imgSrc}" alt="–ó–∞–≤–¥–∞–Ω–Ω—è ${currentTask.task_num}">` : '<p style="color: var(--text-secondary);">–ù–µ–º–∞—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</p>'}
                <div class="answer-box">
                    <strong>–ü—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:</strong> ${currentTask.correct || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}
                </div>
                ${currentTask.question ? `<p style="margin-top: 12px; color: var(--text-secondary);">${currentTask.question}</p>` : ''}
            `;
        }

        function loadSolution() {
            const editor = document.getElementById('latexEditor');
            const preview = document.getElementById('latexPreview');

            if (currentTask?.solution_latex) {
                editor.value = currentTask.solution_latex;
                renderLatexPreview();
            } else {
                editor.value = '';
                preview.innerHTML = '<p style="color: #888; text-align: center;">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –∑\'—è–≤–∏—Ç—å—Å—è —Ç—É—Ç</p>';
            }
        }

        // Claude API
        async function generateSolution() {
            if (!currentTask) {
                alert('–°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å –∑–∞–≤–¥–∞–Ω–Ω—è');
                return;
            }

            if (!apiKey) {
                showApiModal();
                return;
            }

            const btn = document.getElementById('generateBtn');
            const status = document.getElementById('generatingStatus');

            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è...';
            status.innerHTML = '<span class="status-indicator generating"><div class="spinner"></div>–ó–∞–ø–∏—Ç –¥–æ Claude...</span>';

            try {
                // Get image as base64
                const imgSrc = currentTask.photo_url || (currentTask.photo ? `../nmt-trainer/images/${currentTask.photo}` : '');

                if (!imgSrc) {
                    throw new Error('–ù–µ–º–∞—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è');
                }

                // Fetch image and convert to base64
                const imgResp = await fetch(imgSrc);
                const imgBlob = await imgResp.blob();
                const imgBase64 = await blobToBase64(imgBlob);

                // Call Claude API
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 2000,
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: imgBlob.type || 'image/jpeg',
                                        data: imgBase64.split(',')[1]
                                    }
                                },
                                {
                                    type: 'text',
                                    text: getPrompt()
                                }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || 'API Error');
                }

                const data = await response.json();
                const latexCode = data.content[0].text;

                document.getElementById('latexEditor').value = latexCode;
                renderLatexPreview();
                document.getElementById('saveBtn').disabled = false;

                status.innerHTML = '<span class="status-indicator success">–£—Å–ø—ñ—à–Ω–æ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ!</span>';
            } catch (e) {
                console.error(e);
                status.innerHTML = `<span class="status-indicator error">–ü–æ–º–∏–ª–∫–∞: ${e.message}</span>`;
                alert('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Ä–æ–∑–≤\'—è–∑–æ–∫';
            }
        }

        function getPrompt() {
            return `–¢–∏ - –¥–æ—Å–≤—ñ–¥—á–µ–Ω–∏–π —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –∑ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏ –¥–ª—è –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–æ –ù–ú–¢ (–Ω–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π –º—É–ª—å—Ç–∏–ø—Ä–µ–¥–º–µ—Ç–Ω–∏–π —Ç–µ—Å—Ç) –≤ –£–∫—Ä–∞—ó–Ω—ñ.

–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π —Ü–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è —Ç–∞ —Å—Ç–≤–æ—Ä–∏ –¥–µ—Ç–∞–ª—å–Ω–∏–π –ø–æ–∫—Ä–æ–∫–æ–≤–∏–π —Ä–æ–∑–≤'—è–∑–æ–∫.

–ü—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: ${currentTask.correct || '–Ω–µ–≤—ñ–¥–æ–º–∞'}

–í–ê–ñ–õ–ò–í–û - —Ñ–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:
1. –í—ñ–¥–ø–æ–≤—ñ–¥—å –º–∞—î –±—É—Ç–∏ –¢–Ü–õ–¨–ö–ò LaTeX –∫–æ–¥ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ –∫—Ä–æ–∫—ñ–≤ —Ä–æ–∑–≤'—è–∑–∫—É
2. –§–æ—Ä–º–∞—Ç: —Ä—è–¥–∫–∏ —Ç–∞–±–ª–∏—Ü—ñ, –¥–µ –∫–æ–∂–µ–Ω —Ä—è–¥–æ–∫ –º–∞—î —Ñ–æ—Ä–º–∞—Ç:
   –ö—Ä–æ–∫ —Ä–æ–∑–≤'—è–∑–∫—É & –ö–æ—Ä–æ—Ç–∫–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä \\\\
   \\hline
3. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —É–∫—Ä–∞—ó–Ω—Å—å–∫—É –º–æ–≤—É
4. –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω—ñ —Ñ–æ—Ä–º—É–ª–∏ –ø–∏—à–∏ –≤ —Ä–µ–∂–∏–º—ñ $...$
5. –ö—Ä–æ–∫–∏ –º–∞—é—Ç—å –±—É—Ç–∏ –ª–æ–≥—ñ—á–Ω–∏–º–∏ —Ç–∞ –∑—Ä–æ–∑—É–º—ñ–ª–∏–º–∏ –¥–ª—è —É—á–Ω—è 11 –∫–ª–∞—Å—É
6. –û—Å—Ç–∞–Ω–Ω—ñ–π –∫—Ä–æ–∫ - –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ

–ü—Ä–∏–∫–ª–∞–¥ –≤–∏–≤–æ–¥—É (–¢–Ü–õ–¨–ö–ò –†–Ø–î–ö–ò –¢–ê–ë–õ–ò–¶–Ü):
–í–∏–∑–Ω–∞—á–∞—î–º–æ –∑–Ω–∞–∫ –≤–∏—Ä–∞–∑—É –ø—ñ–¥ –º–æ–¥—É–ª–µ–º: $1 - \\sqrt{3}$ & –ü–æ—Ä—ñ–≤–Ω—é—î–º–æ 1 —Ç–∞ $\\sqrt{3}$ \\\\
\\hline
–û—Å–∫—ñ–ª—å–∫–∏ $\\sqrt{3} \\approx 1.732 > 1$, —Ç–æ $1 - \\sqrt{3} < 0$ & –í–∏—Ä–∞–∑ –ø—ñ–¥ –º–æ–¥—É–ª–µ–º –≤—ñ–¥'—î–º–Ω–∏–π \\\\
\\hline
–ó–∞ –æ–∑–Ω–∞—á–µ–Ω–Ω—è–º –º–æ–¥—É–ª—è: $|a| = -a$, —è–∫—â–æ $a < 0$ & –í–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å –º–æ–¥—É–ª—è –¥–ª—è –≤—ñ–¥'—î–º–Ω–∏—Ö —á–∏—Å–µ–ª \\\\
\\hline
$|1 - \\sqrt{3}| = -(1 - \\sqrt{3}) = -1 + \\sqrt{3} = \\sqrt{3} - 1$ & –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –æ–∑–Ω–∞—á–µ–Ω–Ω—è –º–æ–¥—É–ª—è \\\\

–¢–µ–ø–µ—Ä –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –∑–∞–≤–¥–∞–Ω–Ω—è —Ç–∞ –¥–∞–π –¢–Ü–õ–¨–ö–ò —Ä—è–¥–∫–∏ —Ç–∞–±–ª–∏—Ü—ñ LaTeX (–±–µ–∑ –ø—Ä–µ–∞–º–±—É–ª–∏, –±–µ–∑ \\begin{tabular}, —Ç–æ—â–æ):`;
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function renderLatexPreview() {
            const latex = document.getElementById('latexEditor').value;
            const preview = document.getElementById('latexPreview');

            if (!latex.trim()) {
                preview.innerHTML = '<p style="color: #888; text-align: center;">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –∑\'—è–≤–∏—Ç—å—Å—è —Ç—É—Ç</p>';
                return;
            }

            // Create table HTML
            const rows = latex.split('\\hline').map(row => row.trim()).filter(r => r);
            let tableHtml = '<table style="width: 100%; border-collapse: collapse;">';
            tableHtml += '<tr style="background: #ffffcc;"><th style="border: 1px solid #ccc; padding: 8px;">–ö—Ä–æ–∫</th><th style="border: 1px solid #ccc; padding: 8px;">–ö–æ–º–µ–Ω—Ç–∞—Ä</th></tr>';

            rows.forEach(row => {
                const parts = row.replace(/\\\\$/g, '').split('&');
                if (parts.length >= 2) {
                    tableHtml += `<tr>
                        <td style="border: 1px solid #ccc; padding: 8px;">${parts[0].trim()}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${parts[1].trim()}</td>
                    </tr>`;
                }
            });

            tableHtml += '</table>';
            preview.innerHTML = tableHtml;

            // Render KaTeX
            renderMathInElement(preview, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ]
            });

            document.getElementById('saveBtn').disabled = false;
        }

        // Event listener for editor
        document.getElementById('latexEditor').addEventListener('input', () => {
            clearTimeout(window.previewTimeout);
            window.previewTimeout = setTimeout(renderLatexPreview, 500);
        });

        function saveSolution() {
            if (!currentTask) return;

            const latex = document.getElementById('latexEditor').value;
            currentTask.solution_latex = latex;

            // Update the data source
            const value = document.getElementById('testSelect').value;
            const [source, id] = value.split(':');

            if (source === 'nmt' && nmtData) {
                const test = nmtData.test_sets.find(t => t.id === id);
                const task = test?.tasks.find(t => t.task_num === currentTask.task_num);
                if (task) task.solution_latex = latex;
            } else if (classtimeData) {
                const test = classtimeData.test_sets.find(t => t.id === id);
                const task = test?.tasks.find(t => t.task_num === currentTask.task_num);
                if (task) task.solution_latex = latex;
            }

            renderTaskList();
            alert('–ó–±–µ—Ä–µ–∂–µ–Ω–æ! (–ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ)\n\n–î–ª—è –ø–æ—Å—Ç—ñ–π–Ω–æ–≥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –µ–∫—Å–ø–æ—Ä—Ç—É–π—Ç–µ –¥–∞–Ω—ñ.');
        }

        function exportLaTeX() {
            if (!currentTask) return;

            const latex = document.getElementById('latexEditor').value;
            const fullLatex = generateFullLatex(latex);

            const blob = new Blob([fullLatex], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `solution_task${currentTask.task_num}.tex`;
            a.click();
        }

        // Export all data with solutions to JSON
        function exportAllData() {
            const dataToExport = classtimeData || nmtData;
            if (!dataToExport) {
                alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É');
                return;
            }

            // Count solutions
            let solutionCount = 0;
            dataToExport.test_sets.forEach(test => {
                test.tasks.forEach(task => {
                    if (task.solution_latex) solutionCount++;
                });
            });

            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'classtime_data_with_solutions.json';
            a.click();

            alert(`–ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!\n\n${dataToExport.test_sets.length} —Ç–µ—Å—Ç—ñ–≤\n${solutionCount} —Ä–æ–∑–≤'—è–∑–∫—ñ–≤\n\n–ó–∞–º—ñ–Ω—ñ—Ç—å —Ñ–∞–π–ª classtime_data.json –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ.`);
        }

        function generateFullLatex(solutionSteps) {
            return `\\documentclass[12pt,a4paper]{article}
\\usepackage[utf8]{inputenc}
\\usepackage[ukrainian]{babel}
\\usepackage{amsmath,amssymb,amsthm}
\\usepackage{tikz}
\\usepackage{pgfplots}
\\usepackage{geometry}
\\usepackage{array}
\\usepackage{colortbl}
\\usepackage{xcolor}

\\geometry{margin=1.5cm}
\\pagestyle{empty}

\\definecolor{headergreen}{RGB}{183,223,185}
\\definecolor{answerpeach}{RGB}{253,218,192}

\\begin{document}

\\begin{center}
\\colorbox{headergreen}{\\parbox{0.9\\textwidth}{\\centering\\Large\\bfseries –ó–∞–≤–¥–∞–Ω–Ω—è ${currentTask.task_num}}}
\\end{center}

\\vspace{0.5cm}

\\begin{tabular}{|p{0.45\\textwidth}|p{0.45\\textwidth}|}
\\hline
\\rowcolor{yellow!20}
\\textbf{–ö—Ä–æ–∫} & \\textbf{–ö–æ–º–µ–Ω—Ç–∞—Ä} \\\\
\\hline
${solutionSteps}
\\hline
\\end{tabular}

\\vspace{0.5cm}

\\begin{center}
\\colorbox{answerpeach}{\\parbox{0.3\\textwidth}{\\centering\\large\\bfseries –í—ñ–¥–ø–æ–≤—ñ–¥—å: ${currentTask.correct || '?'}}}
\\end{center}

\\end{document}`;
        }

        // API Modal
        function showApiModal() {
            document.getElementById('apiKeyInput').value = apiKey;
            document.getElementById('apiModal').classList.add('active');
        }

        function closeApiModal() {
            document.getElementById('apiModal').classList.remove('active');
        }

        function saveApiKey() {
            apiKey = document.getElementById('apiKeyInput').value.trim();
            localStorage.setItem('anthropic_api_key', apiKey);
            closeApiModal();
        }

        // Init
        init();
    </script>
</body>
</html>
